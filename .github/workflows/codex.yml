name: Codex Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]

jobs:
  codex:
    if: >-
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@codex')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@codex')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@codex'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Codex CLI
        shell: bash
        run: |
          set -euo pipefail
          npm i -g @openai/codex-cli || true
          npx @openai/codex-cli --version || true

      - name: Derive context (base branch, branch name, goal)
        id: ctx
        shell: bash
        run: |
          set -euo pipefail

          # Base, body source URL
          if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            BASE="${{ github.event.pull_request.base.ref }}"
            SRC_URL="${{ github.event.pull_request.html_url }}"
          else
            BASE="${{ github.event.repository.default_branch }}"
            SRC_URL="${{ github.event.issue.html_url }}"
          fi

          # Naƒçti cel√© body z event JSON (multiline)
          BODY="$(jq -r '.comment.body // .issue.body // .pull_request.body // ""' "$GITHUB_EVENT_PATH")"

          # Vyt√°hni v≈°e ZA @codex (case-insensitive, multiline)
          GOAL="$(python3 - <<'PY'
import json, re, sys
evt = json.load(open(sys.argv[1]))
body = (evt.get('comment',{}).get('body') or
        evt.get('issue',{}).get('body') or
        evt.get('pull_request',{}).get('body') or '')
m = re.search(r'@codex\\b(.*)', body, re.I|re.S)
print(m.group(1).strip() if m else '')
PY
"$GITHUB_EVENT_PATH"
)"

          # fallback, pokud po @codex nic nebylo
          if [[ -z "$GOAL" ]]; then
            GOAL="Vy≈ôe≈° po≈æadavek uveden√Ω v souvisej√≠c√≠m issue/koment√°≈ôi komplexnƒõ a bezpeƒçnƒõ. Pokud chyb√≠ detail, navrhni postup a polo≈æ dopl≈àuj√≠c√≠ ot√°zky v PR popisu."
          fi

          # Vƒõtev podle kontextu
          TS=$(date +%Y%m%d-%H%M%S)
          if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            BR="codex/pr-${{ github.event.pull_request.number }}-${TS}"
          else
            BR="codex/issue-${{ github.event.issue.number }}-${TS}"
          fi

          # Debug do bƒõhov√©ho logu
          echo "Base: $BASE"
          echo "Branch: $BR"
          echo "Body length: ${#BODY}"
          echo "Goal length: ${#GOAL}"
          echo "Goal preview:"
          echo "-----"
          echo "${GOAL:0:400}"
          echo "-----"

          # V√Ωstupy pro dal≈°√≠ kroky
          {
            echo "base=$BASE"
            echo "branch=$BR"
            echo "goal<<EOF"
            echo "$GOAL"
            echo "EOF"
            echo "source=$SRC_URL"
            echo "body_len=${#BODY}"
            echo "goal_len=${#GOAL}"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare branch & git identity
        shell: bash
        env:
          BASE: ${{ steps.ctx.outputs.base }}
          BRANCH: ${{ steps.ctx.outputs.branch }}
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin "$BASE" --depth=1
          git checkout -b "$BRANCH" "origin/$BASE"

      - name: Run Codex (make changes, commit locally)
        id: run_codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN:   ${{ secrets.GITHUB_TOKEN }}
          GOAL_TXT:       ${{ steps.ctx.outputs.goal }}
          SOURCE_URL:     ${{ steps.ctx.outputs.source }}
        shell: bash
        run: |
          set -euo pipefail
          test -n "${OPENAI_API_KEY:-}" || { echo "OPENAI_API_KEY chyb√≠"; exit 1; }

          # Slo≈æ p≈ô√≠kaz
          CMD=(npx @openai/codex-cli --repo . --mode full-auto --commit --goal "$GOAL_TXT")
          if [ -n "${SOURCE_URL}" ]; then
            CMD+=("--read" "issue:${SOURCE_URL}")
          fi

          echo "Spou≈°t√≠m: ${CMD[*]}"
          # Samotn√Ω bƒõh
          "${CMD[@]}" | tee codex_output.log || true

          # Pojistka: kdyby CLI nic nezcommitovalo, ale zmƒõny vznikly
          if [[ -n "$(git status --porcelain)" ]]; then
            git add -A
            git commit -m "Codex: apply requested changes" || true
          fi

          # Ulo≈æit struƒçnou diagnostiku pro dal≈°√≠ krok
          echo "has_changes=$(if git diff --quiet HEAD^ HEAD 2>/dev/null; then echo false; else echo true; fi)" >> "$GITHUB_OUTPUT"
          echo "log_size=$(wc -c < codex_output.log | tr -d ' ')" >> "$GITHUB_OUTPUT"

      - name: Push branch to origin (even if empty)
        shell: bash
        env:
          BRANCH: ${{ steps.ctx.outputs.branch }}
        run: |
          set -euo pipefail
          # Pokud v≈Øbec nejsou commity na vƒõtvi (nap≈ô. cli nic neudƒõlalo), vytvo≈ô√≠me aspo≈à pr√°zdnou ‚Äûmarker‚Äú zmƒõnu,
          # a≈• m√° u≈æivatel na co kliknout (stejnƒõ jako Claude vƒõtve zakl√°d√°).
          if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
            echo "No HEAD? creating initial commit"
            date > .codex_marker
            git add .codex_marker
            git commit -m "Codex: marker commit"
          fi
          git push -u origin "$BRANCH"

      - name: Comment with branch & Create PR link (+ diag)
        uses: actions/github-script@v7
        env:
          BASE:      ${{ steps.ctx.outputs.base }}
          BRANCH:    ${{ steps.ctx.outputs.branch }}
          GOAL_LEN:  ${{ steps.ctx.outputs.goal_len }}
          BODY_LEN:  ${{ steps.ctx.outputs.body_len }}
          HAS_CHG:   ${{ steps.run_codex.outputs.has_changes }}
          LOG_SIZE:  ${{ steps.run_codex.outputs.log_size }}
        with:
          script: |
            const issue_number = context.payload.issue
              ? context.payload.issue.number
              : (context.payload.pull_request ? context.payload.pull_request.number : null);
            if (!issue_number) { core.setFailed('No issue/PR to comment on.'); return; }

            const base   = process.env.BASE;
            const branch = process.env.BRANCH;
            const prUrl  = `https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${base}...${branch}?expand=1`;

            const diag = [
              `Diag: body_len=${process.env.BODY_LEN}, goal_len=${process.env.GOAL_LEN}, log_size=${process.env.LOG_SIZE}, has_changes=${process.env.HAS_CHG}`
            ].join('\n');

            const body = [
              '‚úÖ **Codex hotovo**',
              `- Vƒõtev: \`${branch}\``,
              `- Z√°kladn√≠ vƒõtev: \`${base}\``,
              `- üëâ [Create PR](${prUrl})`,
              '',
              diag,
              '',
              (process.env.GOAL_LEN === '0'
                ? '‚ö†Ô∏è Zd√° se, ≈æe po `@codex` nebyl v tƒõle ≈æ√°dn√Ω text. Pou≈æil jsem fallback zad√°n√≠.'
                : '')
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });

      - name: Comment FULL Codex log (chunked)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'codex_output.log';
            const issue_number = context.payload.issue
              ? context.payload.issue.number
              : (context.payload.pull_request ? context.payload.pull_request.number : null);
            if (!issue_number) { core.setFailed('No issue/PR to comment on.'); return; }

            if (!fs.existsSync(path)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body: '‚ö†Ô∏è Nebyl vytvo≈ôen ≈æ√°dn√Ω log (soubor `codex_output.log` chyb√≠).'
              });
              return;
            }

            const whole = fs.readFileSync(path, 'utf8');
            const MAX = 60000;
            const total = Math.max(1, Math.ceil(whole.length / MAX));

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: `üìé **Codex log ‚Äì pln√° d√©lka** (rozsek√°no do ${total} ƒç√°st√≠):`
            });

            for (let i = 0; i < total; i++) {
              const chunk = whole.slice(i * MAX, (i + 1) * MAX);
              const body = `**ƒå√°st ${i + 1}/${total}**\n\n\`\`\`text\n${chunk}\n\`\`\``;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body
              });
            }
