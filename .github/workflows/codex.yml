name: Codex Orchestrator

on:
  # spuÅ¡tÄ›nÃ­ pÅ™es label v issue
  issues:
    types: [opened, edited, labeled, reopened]
  # spuÅ¡tÄ›nÃ­ pÅ™es komentÃ¡Å™ v issue/PR (napÅ™. "@codex run" nebo "@codex plan")
  issue_comment:
    types: [created]
  # na otevÅ™enÃ½ / synchronizovanÃ½ PR â€“ review/opravy
  pull_request:
    types: [opened, synchronize, reopened]
  # manuÃ¡lnÃ­ spuÅ¡tÄ›nÃ­ s parametry
  workflow_dispatch:
    inputs:
      goal:
        description: "CÃ­l pro Codex (volitelnÄ›)"
        required: false
        type: string
      mode:
        description: "ReÅ¾im (plan|edit|full-auto)"
        required: false
        default: "plan"
        type: choice
        options: [plan, edit, full-auto]
  # periodickÃ½ bÄ›h (napÅ™. ÃºdrÅ¾ba, refaktor tipy)
  schedule:
    - cron: "0 4 * * 1" # kaÅ¾dÃ© pondÄ›lÃ­ 04:00 UTC

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  codex:
    runs-on: ubuntu-latest
    concurrency:
      group: codex-${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Codex CLI
        run: |
          npm i -g @openai/codex-cli || true
          npx @openai/codex-cli --version || true

      - name: Derive trigger intent
        id: intent
        shell: bash
        run: |
          # Defaulty
          MODE="plan"
          GOAL="Analyzuj repo a pÅ™iprav nÃ¡vrh zmÄ›n."
          SOURCE_URL=""

          if [[ "${{ github.event_name }}" == "issues" ]]; then
            SOURCE_URL="${{ github.event.issue.html_url }}"
            # pokud mÃ¡ issue label 'codex', jedeme vÃ­c automaticky
            if echo "${{ toJson(github.event.issue.labels) }}" | grep -qi '"name":"codex"'; then
              MODE="full-auto"
              GOAL="VyÅ™eÅ¡ uvedenÃ© issue a pÅ™iprav PR (vÄetnÄ› testÅ¯)."
            else
              MODE="plan"
              GOAL="Zpracuj analÃ½zu k tomuto issue a navrhni konkrÃ©tnÃ­ TODO a PR plÃ¡n."
            fi
          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            SOURCE_URL="${{ github.event.issue.html_url }}"
            BODY="${{ github.event.comment.body }}"
            if echo "$BODY" | grep -qi "@codex run"; then
              MODE="full-auto"
              GOAL="VyÅ™eÅ¡ issue/PR dle kontextu a pÅ™iprav commit/PR."
            elif echo "$BODY" | grep -qi "@codex edit"; then
              MODE="edit"
              GOAL="ProveÄ cÃ­lenÃ© Ãºpravy podle komentÃ¡Å™e."
            elif echo "$BODY" | grep -qi "@codex plan"; then
              MODE="plan"
              GOAL="PÅ™iprav plÃ¡n, diffy a postup krok za krokem."
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SOURCE_URL="${{ github.event.pull_request.html_url }}"
            MODE="plan"
            GOAL="ProveÄ review tohoto PR, navrhni zmÄ›ny a pÅ™Ã­padnÄ› je rovnou proveÄ."
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MODE="${{ github.event.inputs.mode }}"
            GOAL="${{ github.event.inputs.goal }}"
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            MODE="plan"
            GOAL="Najdi technickÃ½ dluh, navrhni refaktor a vytvoÅ™ Ãºlohy/PR nÃ¡vrhy."
          fi

          echo "mode=$MODE"   >> "$GITHUB_OUTPUT"
          echo "goal=$GOAL"   >> "$GITHUB_OUTPUT"
          echo "source=$SOURCE_URL" >> "$GITHUB_OUTPUT"

      - name: Run Codex
        id: codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN:    ${{ secrets.GITHUB_TOKEN }}
        run: |
          # BezpeÄnÃ© defaulty, aÅ¥ se to nespustÃ­ bez klÃ­Äe
          test -n "$OPENAI_API_KEY" || { echo "OPENAI_API_KEY chybÃ­"; exit 1; }

          # Sestav pÅ™Ã­kaz â€“ uprav dle svÃ© instalace CLI.
          CMD="npx @openai/codex-cli \
            --repo . \
            --goal \"${{ steps.intent.outputs.goal }}\" \
            --mode \"${{ steps.intent.outputs.mode }}\""

          if [ -n "${{ steps.intent.outputs.source }}" ]; then
            CMD="$CMD --read \"issue:${{ steps.intent.outputs.source }}\""
          fi

          echo "SpouÅ¡tÃ­m: $CMD"
          eval $CMD | tee codex_output.log || true

      - name: Upload Codex log (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: codex-output
          path: codex_output.log
          if-no-files-found: ignore

      - name: Comment back to issue/PR (summary)
        if: ${{ steps.intent.outputs.source != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          URL="${{ steps.intent.outputs.source }}"
          BODY="âœ… Codex bÄ›h dokonÄen\n\n**ReÅ¾im:** ${{ steps.intent.outputs.mode }}\n**CÃ­l:** ${{ steps.intent.outputs.goal }}\n\nLog je pÅ™iloÅ¾en jako artifact \`codex-output\`."
          # RozliÅ¡Ã­me, zda to je issue nebo PR (obojÃ­ mÃ¡ /issues/ v API)
          API_URL=$(echo "$URL" | sed 's#https://github.com/#https://api.github.com/repos/#; s#/pull/#/issues/#')
          COMMENTS="$API_URL/comments"
          curl -sS -X POST -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
            "$COMMENTS" -d "$(jq -cn --arg body "$BODY" '{body:$body}')" >/dev/null

      - name: Comment FULL Codex log to issue/PR
        if: ${{ (github.event_name == 'issues' || github.event_name == 'issue_comment' || github.event_name == 'pull_request') && steps.intent.outputs.source != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');

            const path = 'codex_output.log';
            if (!fs.existsSync(path)) {
              core.setFailed('codex_output.log not found');
              return;
            }

            const body = fs.readFileSync(path, 'utf8');
            const MAX = 60000; // bezpeÄnÃ½ limit pod hranicÃ­ GitHubu (~65k)
            const total = Math.ceil(body.length / MAX);

            const issue_number = context.payload.issue
              ? context.payload.issue.number
              : (context.payload.pull_request ? context.payload.pull_request.number : null);

            if (!issue_number) {
              core.setFailed('No issue/PR in this event to comment on.');
              return;
            }

            // ÃšvodnÃ­ hlaviÄka
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: `ğŸ“ **Codex log** â€“ plnÃ¡ dÃ©lka, rozdÄ›leno do ${total} ÄÃ¡stÃ­ (po ~${MAX} znacÃ­ch).`
            });

            for (let i = 0; i < total; i++) {
              const start = i * MAX;
              const chunk = body.slice(start, start + MAX);
              const header = `**ÄŒÃ¡st ${i+1}/${total}**\n\n`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body: `${header}\n\`\`\`text\n${chunk}\n\`\`\``
              });
            }
