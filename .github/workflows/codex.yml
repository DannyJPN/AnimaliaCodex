name: Codex Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]

jobs:
  codex:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@codex')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@codex')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@codex'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Codex CLI
        run: |
          npm i -g @openai/codex-cli || true
          npx @openai/codex-cli --version || true

      - name: Derive context (base branch, branch name, goal)
        id: ctx
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            BASE="${{ github.event.pull_request.base.ref }}"
            SRC_URL="${{ github.event.pull_request.html_url }}"
            BODY="${{ github.event.comment.body }}"
          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            BASE="${{ github.event.repository.default_branch }}"
            SRC_URL="${{ github.event.issue.html_url }}"
            BODY="${{ github.event.comment.body }}"
          else
            BASE="${{ github.event.repository.default_branch }}"
            SRC_URL="${{ github.event.issue.html_url }}"
            BODY="${{ github.event.issue.body }}"
          fi

          TS=$(date +%Y%m%d-%H%M%S)
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            BR="codex/issue-${{ github.event.issue.number }}-${TS}"
          elif [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            BR="codex/pr-${{ github.event.pull_request.number }}-${TS}"
          else
            BR="codex/issue-${{ github.event.issue.number }}-${TS}"
          fi

          GOAL=$(echo "$BODY" | sed -n 's/.*@codex[[:space:]]*//p' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')
          if [[ -z "$GOAL" ]]; then
            GOAL="Vy≈ôe≈° po≈æadavek uveden√Ω v souvisej√≠c√≠m issue/koment√°≈ôi komplexnƒõ a bezpeƒçnƒõ."
          fi

          echo "base=$BASE"      >> "$GITHUB_OUTPUT"
          echo "branch=$BR"      >> "$GITHUB_OUTPUT"
          echo "goal=$GOAL"      >> "$GITHUB_OUTPUT"
          echo "source=$SRC_URL" >> "$GITHUB_OUTPUT"

      - name: Prepare branch & git identity
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin "${{ steps.ctx.outputs.base }}" --depth=1
          git checkout -b "${{ steps.ctx.outputs.branch }}" "origin/${{ steps.ctx.outputs.base }}"

      - name: Run Codex (make changes, commit locally)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          test -n "${OPENAI_API_KEY:-}" || { echo "OPENAI_API_KEY chyb√≠"; exit 1; }

          CMD=(npx @openai/codex-cli
               --repo .
               --goal "${{ steps.ctx.outputs.goal }}"
               --mode "full-auto"
               --read "issue:${{ steps.ctx.outputs.source }}"
               --commit)

          echo "Spou≈°t√≠m: ${CMD[*]}"
          "${CMD[@]}" | tee codex_output.log || true

          if [[ -n "$(git status --porcelain)" ]]; then
            git add -A
            git commit -m "Codex: apply requested changes"
          fi

      - name: Push branch to origin
        shell: bash
        run: |
          set -euo pipefail
          git push -u origin "${{ steps.ctx.outputs.branch }}"

      - name: Comment with branch & Create PR link
        uses: actions/github-script@v7
        env:
          BASE: ${{ steps.ctx.outputs.base }}
          BRANCH: ${{ steps.ctx.outputs.branch }}
        with:
          script: |
            const issue_number = context.payload.issue
              ? context.payload.issue.number
              : (context.payload.pull_request ? context.payload.pull_request.number : null);
            if (!issue_number) { core.setFailed('No issue/PR to comment on.'); return; }

            const base   = process.env.BASE;
            const branch = process.env.BRANCH;
            const prUrl  = `https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${base}...${branch}?expand=1`;

            const body =
`‚úÖ **Codex hotovo**
- Vƒõtev: \`${branch}\`
- Z√°kladn√≠ vƒõtev: \`${base}\`
- üëâ [Create PR](${prUrl})

Pln√Ω log je v n√°sleduj√≠c√≠ch koment√°≈ô√≠ch.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });

      - name: Comment FULL Codex log (chunked)
        uses: actions/github-script@v7
        env:
          # jen pro jistotu, kdybys chtƒõl nƒõco z ENV pou≈æ√≠t i tady
          DUMMY: ok
        with:
          script: |
            const fs = require('fs');
            const path = 'codex_output.log';
            if (!fs.existsSync(path)) { core.setFailed('codex_output.log not found'); return; }

            const whole = fs.readFileSync(path, 'utf8');
            const MAX = 60000; // bezpeƒçnƒõ pod limitem GitHubu
            const total = Math.max(1, Math.ceil(whole.length / MAX));

            const issue_number = context.payload.issue
              ? context.payload.issue.number
              : (context.payload.pull_request ? context.payload.pull_request.number : null);
            if (!issue_number) { core.setFailed('No issue/PR to comment on.'); return; }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: `üìé **Codex log ‚Äì pln√° d√©lka** (rozsek√°no do ${total} ƒç√°st√≠):`
            });

            for (let i = 0; i < total; i++) {
              const chunk = whole.slice(i * MAX, (i + 1) * MAX);
              const body = `**ƒå√°st ${i + 1}/${total}**\n\n\`\`\`text\n${chunk}\n\`\`\``;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body
              });
            }
